/**
 * Updated 21/11/2024
 *
 * CONFORMA/DOCKER LAUNCH SCRIPT
 *
 * This script can be compiled and placed on a server (or locally) and used to
 * launch Conforma Docker containers using configuration options specified in
 * either:
 * - environment variables
 * - a site-specific "env" file (place in /env_files/<site>.env)
 * - a common "default.env" file (in the same location as the launch script)
 *
 * See env_files/example.env and default.env in this folder for examples
 *
 * Launch the script with "node launch.mjs <site1> <site2> ..."
 *
 * Will prompt for a single site if site args are omitted.
 *
 * To create a global alias (that can be run from anywhere), add the following
 * line to the host shell configuration file (probably ~/.zshrc or ~/.bashrc):
 *
 * alias launch_conforma="node /path/to/script_folder/launch.mjs"
 */

import e from"fs";import t from"constants";import n from"stream";import r from"util";import i from"assert";import o from"path";import c,{spawn as s}from"child_process";import a from"os";import u from"crypto";var l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function f(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var p={},y={fromCallback:function(e){return Object.defineProperty((function(...t){if("function"!=typeof t[t.length-1])return new Promise(((n,r)=>{t.push(((e,t)=>null!=e?r(e):n(t))),e.apply(this,t)}));e.apply(this,t)}),"name",{value:e.name})},fromPromise:function(e){return Object.defineProperty((function(...t){const n=t[t.length-1];if("function"!=typeof n)return e.apply(this,t);t.pop(),e.apply(this,t).then((e=>n(null,e)),n)}),"name",{value:e.name})}},d=t,h=process.cwd,m=null,S=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){return m||(m=h.call(process)),m};try{process.cwd()}catch(e){}if("function"==typeof process.chdir){var w=process.chdir;process.chdir=function(e){m=null,w.call(process,e)},Object.setPrototypeOf&&Object.setPrototypeOf(process.chdir,w)}var v=function(e){d.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&function(e){e.lchmod=function(t,n,r){e.open(t,d.O_WRONLY|d.O_SYMLINK,n,(function(t,i){t?r&&r(t):e.fchmod(i,n,(function(t){e.close(i,(function(e){r&&r(t||e)}))}))}))},e.lchmodSync=function(t,n){var r,i=e.openSync(t,d.O_WRONLY|d.O_SYMLINK,n),o=!0;try{r=e.fchmodSync(i,n),o=!1}finally{if(o)try{e.closeSync(i)}catch(e){}else e.closeSync(i)}return r}}(e);e.lutimes||function(e){d.hasOwnProperty("O_SYMLINK")&&e.futimes?(e.lutimes=function(t,n,r,i){e.open(t,d.O_SYMLINK,(function(t,o){t?i&&i(t):e.futimes(o,n,r,(function(t){e.close(o,(function(e){i&&i(t||e)}))}))}))},e.lutimesSync=function(t,n,r){var i,o=e.openSync(t,d.O_SYMLINK),c=!0;try{i=e.futimesSync(o,n,r),c=!1}finally{if(c)try{e.closeSync(o)}catch(e){}else e.closeSync(o)}return i}):e.futimes&&(e.lutimes=function(e,t,n,r){r&&process.nextTick(r)},e.lutimesSync=function(){})}(e);e.chown=r(e.chown),e.fchown=r(e.fchown),e.lchown=r(e.lchown),e.chmod=t(e.chmod),e.fchmod=t(e.fchmod),e.lchmod=t(e.lchmod),e.chownSync=i(e.chownSync),e.fchownSync=i(e.fchownSync),e.lchownSync=i(e.lchownSync),e.chmodSync=n(e.chmodSync),e.fchmodSync=n(e.fchmodSync),e.lchmodSync=n(e.lchmodSync),e.stat=o(e.stat),e.fstat=o(e.fstat),e.lstat=o(e.lstat),e.statSync=c(e.statSync),e.fstatSync=c(e.fstatSync),e.lstatSync=c(e.lstatSync),e.chmod&&!e.lchmod&&(e.lchmod=function(e,t,n){n&&process.nextTick(n)},e.lchmodSync=function(){});e.chown&&!e.lchown&&(e.lchown=function(e,t,n,r){r&&process.nextTick(r)},e.lchownSync=function(){});"win32"===S&&(e.rename="function"!=typeof e.rename?e.rename:function(t){function n(n,r,i){var o=Date.now(),c=0;t(n,r,(function s(a){if(a&&("EACCES"===a.code||"EPERM"===a.code||"EBUSY"===a.code)&&Date.now()-o<6e4)return setTimeout((function(){e.stat(r,(function(e,o){e&&"ENOENT"===e.code?t(n,r,s):i(a)}))}),c),void(c<100&&(c+=10));i&&i(a)}))}return Object.setPrototypeOf&&Object.setPrototypeOf(n,t),n}(e.rename));function t(t){return t?function(n,r,i){return t.call(e,n,r,(function(e){s(e)&&(e=null),i&&i.apply(this,arguments)}))}:t}function n(t){return t?function(n,r){try{return t.call(e,n,r)}catch(e){if(!s(e))throw e}}:t}function r(t){return t?function(n,r,i,o){return t.call(e,n,r,i,(function(e){s(e)&&(e=null),o&&o.apply(this,arguments)}))}:t}function i(t){return t?function(n,r,i){try{return t.call(e,n,r,i)}catch(e){if(!s(e))throw e}}:t}function o(t){return t?function(n,r,i){function o(e,t){t&&(t.uid<0&&(t.uid+=4294967296),t.gid<0&&(t.gid+=4294967296)),i&&i.apply(this,arguments)}return"function"==typeof r&&(i=r,r=null),r?t.call(e,n,r,o):t.call(e,n,o)}:t}function c(t){return t?function(n,r){var i=r?t.call(e,n,r):t.call(e,n);return i&&(i.uid<0&&(i.uid+=4294967296),i.gid<0&&(i.gid+=4294967296)),i}:t}function s(e){return!e||("ENOSYS"===e.code||!(process.getuid&&0===process.getuid()||"EINVAL"!==e.code&&"EPERM"!==e.code))}e.read="function"!=typeof e.read?e.read:function(t){function n(n,r,i,o,c,s){var a;if(s&&"function"==typeof s){var u=0;a=function(l,f,p){if(l&&"EAGAIN"===l.code&&u<10)return u++,t.call(e,n,r,i,o,c,a);s.apply(this,arguments)}}return t.call(e,n,r,i,o,c,a)}return Object.setPrototypeOf&&Object.setPrototypeOf(n,t),n}(e.read),e.readSync="function"!=typeof e.readSync?e.readSync:(a=e.readSync,function(t,n,r,i,o){for(var c=0;;)try{return a.call(e,t,n,r,i,o)}catch(e){if("EAGAIN"===e.code&&c<10){c++;continue}throw e}});var a};var g=n.Stream,E=function(e){return{ReadStream:function t(n,r){if(!(this instanceof t))return new t(n,r);g.call(this);var i=this;this.path=n,this.fd=null,this.readable=!0,this.paused=!1,this.flags="r",this.mode=438,this.bufferSize=65536,r=r||{};for(var o=Object.keys(r),c=0,s=o.length;c<s;c++){var a=o[c];this[a]=r[a]}this.encoding&&this.setEncoding(this.encoding);if(void 0!==this.start){if("number"!=typeof this.start)throw TypeError("start must be a Number");if(void 0===this.end)this.end=1/0;else if("number"!=typeof this.end)throw TypeError("end must be a Number");if(this.start>this.end)throw new Error("start must be <= end");this.pos=this.start}if(null!==this.fd)return void process.nextTick((function(){i._read()}));e.open(this.path,this.flags,this.mode,(function(e,t){if(e)return i.emit("error",e),void(i.readable=!1);i.fd=t,i.emit("open",t),i._read()}))},WriteStream:function t(n,r){if(!(this instanceof t))return new t(n,r);g.call(this),this.path=n,this.fd=null,this.writable=!0,this.flags="w",this.encoding="binary",this.mode=438,this.bytesWritten=0,r=r||{};for(var i=Object.keys(r),o=0,c=i.length;o<c;o++){var s=i[o];this[s]=r[s]}if(void 0!==this.start){if("number"!=typeof this.start)throw TypeError("start must be a Number");if(this.start<0)throw new Error("start must be >= zero");this.pos=this.start}this.busy=!1,this._queue=[],null===this.fd&&(this._open=e.open,this._queue.push([this._open,this.path,this.flags,this.mode,void 0]),this.flush())}}};var k=function(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Object)var t={__proto__:b(e)};else t=Object.create(null);return Object.getOwnPropertyNames(e).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})),t},b=Object.getPrototypeOf||function(e){return e.__proto__};var O,P,F=e,C=v,x=E,_=k,N=r;function $(e,t){Object.defineProperty(e,O,{get:function(){return t}})}"function"==typeof Symbol&&"function"==typeof Symbol.for?(O=Symbol.for("graceful-fs.queue"),P=Symbol.for("graceful-fs.previous")):(O="___graceful-fs.queue",P="___graceful-fs.previous");var T=function(){};if(N.debuglog?T=N.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(T=function(){var e=N.format.apply(N,arguments);e="GFS4: "+e.split(/\n/).join("\nGFS4: "),console.error(e)}),!F[O]){var D=l[O]||[];$(F,D),F.close=function(e){function t(t,n){return e.call(F,t,(function(e){e||j(),"function"==typeof n&&n.apply(this,arguments)}))}return Object.defineProperty(t,P,{value:e}),t}(F.close),F.closeSync=function(e){function t(t){e.apply(F,arguments),j()}return Object.defineProperty(t,P,{value:e}),t}(F.closeSync),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",(function(){T(F[O]),i.equal(F[O].length,0)}))}l[O]||$(l,F[O]);var R,I=L(_(F));function L(e){C(e),e.gracefulify=L,e.createReadStream=function(t,n){return new e.ReadStream(t,n)},e.createWriteStream=function(t,n){return new e.WriteStream(t,n)};var t=e.readFile;e.readFile=function(e,n,r){"function"==typeof n&&(r=n,n=null);return function e(n,r,i,o){return t(n,r,(function(t){!t||"EMFILE"!==t.code&&"ENFILE"!==t.code?"function"==typeof i&&i.apply(this,arguments):A([e,[n,r,i],t,o||Date.now(),Date.now()])}))}(e,n,r)};var n=e.writeFile;e.writeFile=function(e,t,r,i){"function"==typeof r&&(i=r,r=null);return function e(t,r,i,o,c){return n(t,r,i,(function(n){!n||"EMFILE"!==n.code&&"ENFILE"!==n.code?"function"==typeof o&&o.apply(this,arguments):A([e,[t,r,i,o],n,c||Date.now(),Date.now()])}))}(e,t,r,i)};var r=e.appendFile;r&&(e.appendFile=function(e,t,n,i){"function"==typeof n&&(i=n,n=null);return function e(t,n,i,o,c){return r(t,n,i,(function(r){!r||"EMFILE"!==r.code&&"ENFILE"!==r.code?"function"==typeof o&&o.apply(this,arguments):A([e,[t,n,i,o],r,c||Date.now(),Date.now()])}))}(e,t,n,i)});var i=e.copyFile;i&&(e.copyFile=function(e,t,n,r){"function"==typeof n&&(r=n,n=0);return function e(t,n,r,o,c){return i(t,n,r,(function(i){!i||"EMFILE"!==i.code&&"ENFILE"!==i.code?"function"==typeof o&&o.apply(this,arguments):A([e,[t,n,r,o],i,c||Date.now(),Date.now()])}))}(e,t,n,r)});var o=e.readdir;e.readdir=function(e,t,n){"function"==typeof t&&(n=t,t=null);var r=c.test(process.version)?function(e,t,n,r){return o(e,i(e,t,n,r))}:function(e,t,n,r){return o(e,t,i(e,t,n,r))};return r(e,t,n);function i(e,t,n,i){return function(o,c){!o||"EMFILE"!==o.code&&"ENFILE"!==o.code?(c&&c.sort&&c.sort(),"function"==typeof n&&n.call(this,o,c)):A([r,[e,t,n],o,i||Date.now(),Date.now()])}}};var c=/^v[0-5]\./;if("v0.8"===process.version.substr(0,4)){var s=x(e);p=s.ReadStream,y=s.WriteStream}var a=e.ReadStream;a&&(p.prototype=Object.create(a.prototype),p.prototype.open=function(){var e=this;h(e.path,e.flags,e.mode,(function(t,n){t?(e.autoClose&&e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n),e.read())}))});var u=e.WriteStream;u&&(y.prototype=Object.create(u.prototype),y.prototype.open=function(){var e=this;h(e.path,e.flags,e.mode,(function(t,n){t?(e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n))}))}),Object.defineProperty(e,"ReadStream",{get:function(){return p},set:function(e){p=e},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WriteStream",{get:function(){return y},set:function(e){y=e},enumerable:!0,configurable:!0});var l=p;Object.defineProperty(e,"FileReadStream",{get:function(){return l},set:function(e){l=e},enumerable:!0,configurable:!0});var f=y;function p(e,t){return this instanceof p?(a.apply(this,arguments),this):p.apply(Object.create(p.prototype),arguments)}function y(e,t){return this instanceof y?(u.apply(this,arguments),this):y.apply(Object.create(y.prototype),arguments)}Object.defineProperty(e,"FileWriteStream",{get:function(){return f},set:function(e){f=e},enumerable:!0,configurable:!0});var d=e.open;function h(e,t,n,r){return"function"==typeof n&&(r=n,n=null),function e(t,n,r,i,o){return d(t,n,r,(function(c,s){!c||"EMFILE"!==c.code&&"ENFILE"!==c.code?"function"==typeof i&&i.apply(this,arguments):A([e,[t,n,r,i],c,o||Date.now(),Date.now()])}))}(e,t,n,r)}return e.open=h,e}function A(e){T("ENQUEUE",e[0].name,e[1]),F[O].push(e),M()}function j(){for(var e=Date.now(),t=0;t<F[O].length;++t)F[O][t].length>2&&(F[O][t][3]=e,F[O][t][4]=e);M()}function M(){if(clearTimeout(R),R=void 0,0!==F[O].length){var e=F[O].shift(),t=e[0],n=e[1],r=e[2],i=e[3],o=e[4];if(void 0===i)T("RETRY",t.name,n),t.apply(null,n);else if(Date.now()-i>=6e4){T("TIMEOUT",t.name,n);var c=n.pop();"function"==typeof c&&c.call(null,r)}else{var s=Date.now()-o,a=Math.max(o-i,1);s>=Math.min(1.2*a,100)?(T("RETRY",t.name,n),t.apply(null,n.concat([i]))):F[O].push(e)}void 0===R&&(R=setTimeout(M,0))}}process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&!F.__patched&&(I=L(F),F.__patched=!0),function(e){const t=y.fromCallback,n=I,r=["access","appendFile","chmod","chown","close","copyFile","fchmod","fchown","fdatasync","fstat","fsync","ftruncate","futimes","lchmod","lchown","link","lstat","mkdir","mkdtemp","open","opendir","readdir","readFile","readlink","realpath","rename","rm","rmdir","stat","symlink","truncate","unlink","utimes","writeFile"].filter((e=>"function"==typeof n[e]));Object.assign(e,n),r.forEach((r=>{e[r]=t(n[r])})),e.exists=function(e,t){return"function"==typeof t?n.exists(e,t):new Promise((t=>n.exists(e,t)))},e.read=function(e,t,r,i,o,c){return"function"==typeof c?n.read(e,t,r,i,o,c):new Promise(((c,s)=>{n.read(e,t,r,i,o,((e,t,n)=>{if(e)return s(e);c({bytesRead:t,buffer:n})}))}))},e.write=function(e,t,...r){return"function"==typeof r[r.length-1]?n.write(e,t,...r):new Promise(((i,o)=>{n.write(e,t,...r,((e,t,n)=>{if(e)return o(e);i({bytesWritten:t,buffer:n})}))}))},e.readv=function(e,t,...r){return"function"==typeof r[r.length-1]?n.readv(e,t,...r):new Promise(((i,o)=>{n.readv(e,t,...r,((e,t,n)=>{if(e)return o(e);i({bytesRead:t,buffers:n})}))}))},e.writev=function(e,t,...r){return"function"==typeof r[r.length-1]?n.writev(e,t,...r):new Promise(((i,o)=>{n.writev(e,t,...r,((e,t,n)=>{if(e)return o(e);i({bytesWritten:t,buffers:n})}))}))},"function"==typeof n.realpath.native?e.realpath.native=t(n.realpath.native):process.emitWarning("fs.realpath.native is not a function. Is fs being monkey-patched?","Warning","fs-extra-WARN0003")}(p);var B={},W={};const V=o;W.checkPath=function(e){if("win32"===process.platform){if(/[<>:"|?*]/.test(e.replace(V.parse(e).root,""))){const t=new Error(`Path contains invalid characters: ${e}`);throw t.code="EINVAL",t}}};const H=p,{checkPath:J}=W,U=e=>"number"==typeof e?e:{mode:511,...e}.mode;B.makeDir=async(e,t)=>(J(e),H.mkdir(e,{mode:U(t),recursive:!0})),B.makeDirSync=(e,t)=>(J(e),H.mkdirSync(e,{mode:U(t),recursive:!0}));const Q=y.fromPromise,{makeDir:G,makeDirSync:z}=B,Y=Q(G);var q={mkdirs:Y,mkdirsSync:z,mkdirp:Y,mkdirpSync:z,ensureDir:Y,ensureDirSync:z};const K=y.fromPromise,Z=p;var X={pathExists:K((function(e){return Z.access(e).then((()=>!0)).catch((()=>!1))})),pathExistsSync:Z.existsSync};const ee=p;var te={utimesMillis:(0,y.fromPromise)((async function(e,t,n){const r=await ee.open(e,"r+");let i=null;try{await ee.futimes(r,t,n)}finally{try{await ee.close(r)}catch(e){i=e}}if(i)throw i})),utimesMillisSync:function(e,t,n){const r=ee.openSync(e,"r+");return ee.futimesSync(r,t,n),ee.closeSync(r)}};const ne=p,re=o,ie=y.fromPromise;function oe(e,t){return t.ino&&t.dev&&t.ino===e.ino&&t.dev===e.dev}function ce(e,t){const n=re.resolve(e).split(re.sep).filter((e=>e)),r=re.resolve(t).split(re.sep).filter((e=>e));return n.every(((e,t)=>r[t]===e))}function se(e,t,n){return`Cannot ${n} '${e}' to a subdirectory of itself, '${t}'.`}var ae={checkPaths:ie((async function(e,t,n,r){const{srcStat:i,destStat:o}=await function(e,t,n){const r=n.dereference?e=>ne.stat(e,{bigint:!0}):e=>ne.lstat(e,{bigint:!0});return Promise.all([r(e),r(t).catch((e=>{if("ENOENT"===e.code)return null;throw e}))]).then((([e,t])=>({srcStat:e,destStat:t})))}(e,t,r);if(o){if(oe(i,o)){const r=re.basename(e),c=re.basename(t);if("move"===n&&r!==c&&r.toLowerCase()===c.toLowerCase())return{srcStat:i,destStat:o,isChangingCase:!0};throw new Error("Source and destination must not be the same.")}if(i.isDirectory()&&!o.isDirectory())throw new Error(`Cannot overwrite non-directory '${t}' with directory '${e}'.`);if(!i.isDirectory()&&o.isDirectory())throw new Error(`Cannot overwrite directory '${t}' with non-directory '${e}'.`)}if(i.isDirectory()&&ce(e,t))throw new Error(se(e,t,n));return{srcStat:i,destStat:o}})),checkPathsSync:function(e,t,n,r){const{srcStat:i,destStat:o}=function(e,t,n){let r;const i=n.dereference?e=>ne.statSync(e,{bigint:!0}):e=>ne.lstatSync(e,{bigint:!0}),o=i(e);try{r=i(t)}catch(e){if("ENOENT"===e.code)return{srcStat:o,destStat:null};throw e}return{srcStat:o,destStat:r}}(e,t,r);if(o){if(oe(i,o)){const r=re.basename(e),c=re.basename(t);if("move"===n&&r!==c&&r.toLowerCase()===c.toLowerCase())return{srcStat:i,destStat:o,isChangingCase:!0};throw new Error("Source and destination must not be the same.")}if(i.isDirectory()&&!o.isDirectory())throw new Error(`Cannot overwrite non-directory '${t}' with directory '${e}'.`);if(!i.isDirectory()&&o.isDirectory())throw new Error(`Cannot overwrite directory '${t}' with non-directory '${e}'.`)}if(i.isDirectory()&&ce(e,t))throw new Error(se(e,t,n));return{srcStat:i,destStat:o}},checkParentPaths:ie((async function e(t,n,r,i){const o=re.resolve(re.dirname(t)),c=re.resolve(re.dirname(r));if(c===o||c===re.parse(c).root)return;let s;try{s=await ne.stat(c,{bigint:!0})}catch(e){if("ENOENT"===e.code)return;throw e}if(oe(n,s))throw new Error(se(t,r,i));return e(t,n,c,i)})),checkParentPathsSync:function e(t,n,r,i){const o=re.resolve(re.dirname(t)),c=re.resolve(re.dirname(r));if(c===o||c===re.parse(c).root)return;let s;try{s=ne.statSync(c,{bigint:!0})}catch(e){if("ENOENT"===e.code)return;throw e}if(oe(n,s))throw new Error(se(t,r,i));return e(t,n,c,i)},isSrcSubdir:ce,areIdentical:oe};const ue=p,le=o,{mkdirs:fe}=q,{pathExists:pe}=X,{utimesMillis:ye}=te,de=ae;async function he(e,t,n){return!n.filter||n.filter(e,t)}async function me(e,t,n,r){const i=r.dereference?ue.stat:ue.lstat,o=await i(t);if(o.isDirectory())return async function(e,t,n,r,i){t||await ue.mkdir(r);const o=await ue.readdir(n);await Promise.all(o.map((async e=>{const t=le.join(n,e),o=le.join(r,e);if(!await he(t,o,i))return;const{destStat:c}=await de.checkPaths(t,o,"copy",i);return me(c,t,o,i)}))),t||await ue.chmod(r,e.mode)}(o,e,t,n,r);if(o.isFile()||o.isCharacterDevice()||o.isBlockDevice())return async function(e,t,n,r,i){if(!t)return Se(e,n,r,i);if(i.overwrite)return await ue.unlink(r),Se(e,n,r,i);if(i.errorOnExist)throw new Error(`'${r}' already exists`)}(o,e,t,n,r);if(o.isSymbolicLink())return async function(e,t,n,r){let i=await ue.readlink(t);r.dereference&&(i=le.resolve(process.cwd(),i));if(!e)return ue.symlink(i,n);let o=null;try{o=await ue.readlink(n)}catch(e){if("EINVAL"===e.code||"UNKNOWN"===e.code)return ue.symlink(i,n);throw e}r.dereference&&(o=le.resolve(process.cwd(),o));if(de.isSrcSubdir(i,o))throw new Error(`Cannot copy '${i}' to a subdirectory of itself, '${o}'.`);if(de.isSrcSubdir(o,i))throw new Error(`Cannot overwrite '${o}' with '${i}'.`);return await ue.unlink(n),ue.symlink(i,n)}(e,t,n,r);if(o.isSocket())throw new Error(`Cannot copy a socket file: ${t}`);if(o.isFIFO())throw new Error(`Cannot copy a FIFO pipe: ${t}`);throw new Error(`Unknown file: ${t}`)}async function Se(e,t,n,r){if(await ue.copyFile(t,n),r.preserveTimestamps){128&e.mode||await function(e,t){return ue.chmod(e,128|t)}(n,e.mode);const r=await ue.stat(t);await ye(n,r.atime,r.mtime)}return ue.chmod(n,e.mode)}var we=async function(e,t,n={}){"function"==typeof n&&(n={filter:n}),n.clobber=!("clobber"in n)||!!n.clobber,n.overwrite="overwrite"in n?!!n.overwrite:n.clobber,n.preserveTimestamps&&"ia32"===process.arch&&process.emitWarning("Using the preserveTimestamps option in 32-bit node is not recommended;\n\n\tsee https://github.com/jprichardson/node-fs-extra/issues/269","Warning","fs-extra-WARN0001");const{srcStat:r,destStat:i}=await de.checkPaths(e,t,"copy",n);if(await de.checkParentPaths(e,r,t,"copy"),!await he(e,t,n))return;const o=le.dirname(t);await pe(o)||await fe(o),await me(i,e,t,n)};const ve=I,ge=o,Ee=q.mkdirsSync,ke=te.utimesMillisSync,be=ae;function Oe(e,t,n,r){const i=(r.dereference?ve.statSync:ve.lstatSync)(t);if(i.isDirectory())return function(e,t,n,r,i){return t?Ce(n,r,i):function(e,t,n,r){return ve.mkdirSync(n),Ce(t,n,r),Fe(n,e)}(e.mode,n,r,i)}(i,e,t,n,r);if(i.isFile()||i.isCharacterDevice()||i.isBlockDevice())return function(e,t,n,r,i){return t?function(e,t,n,r){if(r.overwrite)return ve.unlinkSync(n),Pe(e,t,n,r);if(r.errorOnExist)throw new Error(`'${n}' already exists`)}(e,n,r,i):Pe(e,n,r,i)}(i,e,t,n,r);if(i.isSymbolicLink())return function(e,t,n,r){let i=ve.readlinkSync(t);r.dereference&&(i=ge.resolve(process.cwd(),i));if(e){let e;try{e=ve.readlinkSync(n)}catch(e){if("EINVAL"===e.code||"UNKNOWN"===e.code)return ve.symlinkSync(i,n);throw e}if(r.dereference&&(e=ge.resolve(process.cwd(),e)),be.isSrcSubdir(i,e))throw new Error(`Cannot copy '${i}' to a subdirectory of itself, '${e}'.`);if(be.isSrcSubdir(e,i))throw new Error(`Cannot overwrite '${e}' with '${i}'.`);return function(e,t){return ve.unlinkSync(t),ve.symlinkSync(e,t)}(i,n)}return ve.symlinkSync(i,n)}(e,t,n,r);if(i.isSocket())throw new Error(`Cannot copy a socket file: ${t}`);if(i.isFIFO())throw new Error(`Cannot copy a FIFO pipe: ${t}`);throw new Error(`Unknown file: ${t}`)}function Pe(e,t,n,r){return ve.copyFileSync(t,n),r.preserveTimestamps&&function(e,t,n){(function(e){return!(128&e)})(e)&&function(e,t){Fe(e,128|t)}(n,e);(function(e,t){const n=ve.statSync(e);ke(t,n.atime,n.mtime)})(t,n)}(e.mode,t,n),Fe(n,e.mode)}function Fe(e,t){return ve.chmodSync(e,t)}function Ce(e,t,n){ve.readdirSync(e).forEach((r=>function(e,t,n,r){const i=ge.join(t,e),o=ge.join(n,e);if(r.filter&&!r.filter(i,o))return;const{destStat:c}=be.checkPathsSync(i,o,"copy",r);return Oe(c,i,o,r)}(r,e,t,n)))}var xe=function(e,t,n){"function"==typeof n&&(n={filter:n}),(n=n||{}).clobber=!("clobber"in n)||!!n.clobber,n.overwrite="overwrite"in n?!!n.overwrite:n.clobber,n.preserveTimestamps&&"ia32"===process.arch&&process.emitWarning("Using the preserveTimestamps option in 32-bit node is not recommended;\n\n\tsee https://github.com/jprichardson/node-fs-extra/issues/269","Warning","fs-extra-WARN0002");const{srcStat:r,destStat:i}=be.checkPathsSync(e,t,"copy",n);if(be.checkParentPathsSync(e,r,t,"copy"),n.filter&&!n.filter(e,t))return;const o=ge.dirname(t);return ve.existsSync(o)||Ee(o),Oe(i,e,t,n)};var _e={copy:(0,y.fromPromise)(we),copySync:xe};const Ne=I;var $e={remove:(0,y.fromCallback)((function(e,t){Ne.rm(e,{recursive:!0,force:!0},t)})),removeSync:function(e){Ne.rmSync(e,{recursive:!0,force:!0})}};const Te=y.fromPromise,De=p,Re=o,Ie=q,Le=$e,Ae=Te((async function(e){let t;try{t=await De.readdir(e)}catch{return Ie.mkdirs(e)}return Promise.all(t.map((t=>Le.remove(Re.join(e,t)))))}));function je(e){let t;try{t=De.readdirSync(e)}catch{return Ie.mkdirsSync(e)}t.forEach((t=>{t=Re.join(e,t),Le.removeSync(t)}))}var Me={emptyDirSync:je,emptydirSync:je,emptyDir:Ae,emptydir:Ae};const Be=y.fromPromise,We=o,Ve=p,He=q;var Je={createFile:Be((async function(e){let t;try{t=await Ve.stat(e)}catch{}if(t&&t.isFile())return;const n=We.dirname(e);let r=null;try{r=await Ve.stat(n)}catch(t){if("ENOENT"===t.code)return await He.mkdirs(n),void await Ve.writeFile(e,"");throw t}r.isDirectory()?await Ve.writeFile(e,""):await Ve.readdir(n)})),createFileSync:function(e){let t;try{t=Ve.statSync(e)}catch{}if(t&&t.isFile())return;const n=We.dirname(e);try{Ve.statSync(n).isDirectory()||Ve.readdirSync(n)}catch(e){if(!e||"ENOENT"!==e.code)throw e;He.mkdirsSync(n)}Ve.writeFileSync(e,"")}};const Ue=y.fromPromise,Qe=o,Ge=p,ze=q,{pathExists:Ye}=X,{areIdentical:qe}=ae;var Ke={createLink:Ue((async function(e,t){let n,r;try{n=await Ge.lstat(t)}catch{}try{r=await Ge.lstat(e)}catch(e){throw e.message=e.message.replace("lstat","ensureLink"),e}if(n&&qe(r,n))return;const i=Qe.dirname(t);await Ye(i)||await ze.mkdirs(i),await Ge.link(e,t)})),createLinkSync:function(e,t){let n;try{n=Ge.lstatSync(t)}catch{}try{const t=Ge.lstatSync(e);if(n&&qe(t,n))return}catch(e){throw e.message=e.message.replace("lstat","ensureLink"),e}const r=Qe.dirname(t);return Ge.existsSync(r)||ze.mkdirsSync(r),Ge.linkSync(e,t)}};const Ze=o,Xe=p,{pathExists:et}=X;var tt={symlinkPaths:(0,y.fromPromise)((async function(e,t){if(Ze.isAbsolute(e)){try{await Xe.lstat(e)}catch(e){throw e.message=e.message.replace("lstat","ensureSymlink"),e}return{toCwd:e,toDst:e}}const n=Ze.dirname(t),r=Ze.join(n,e);if(await et(r))return{toCwd:r,toDst:e};try{await Xe.lstat(e)}catch(e){throw e.message=e.message.replace("lstat","ensureSymlink"),e}return{toCwd:e,toDst:Ze.relative(n,e)}})),symlinkPathsSync:function(e,t){if(Ze.isAbsolute(e)){if(!Xe.existsSync(e))throw new Error("absolute srcpath does not exist");return{toCwd:e,toDst:e}}const n=Ze.dirname(t),r=Ze.join(n,e);if(Xe.existsSync(r))return{toCwd:r,toDst:e};if(!Xe.existsSync(e))throw new Error("relative srcpath does not exist");return{toCwd:e,toDst:Ze.relative(n,e)}}};const nt=p;var rt={symlinkType:(0,y.fromPromise)((async function(e,t){if(t)return t;let n;try{n=await nt.lstat(e)}catch{return"file"}return n&&n.isDirectory()?"dir":"file"})),symlinkTypeSync:function(e,t){if(t)return t;let n;try{n=nt.lstatSync(e)}catch{return"file"}return n&&n.isDirectory()?"dir":"file"}};const it=y.fromPromise,ot=o,ct=p,{mkdirs:st,mkdirsSync:at}=q,{symlinkPaths:ut,symlinkPathsSync:lt}=tt,{symlinkType:ft,symlinkTypeSync:pt}=rt,{pathExists:yt}=X,{areIdentical:dt}=ae;var ht={createSymlink:it((async function(e,t,n){let r;try{r=await ct.lstat(t)}catch{}if(r&&r.isSymbolicLink()){const[n,r]=await Promise.all([ct.stat(e),ct.stat(t)]);if(dt(n,r))return}const i=await ut(e,t);e=i.toDst;const o=await ft(i.toCwd,n),c=ot.dirname(t);return await yt(c)||await st(c),ct.symlink(e,t,o)})),createSymlinkSync:function(e,t,n){let r;try{r=ct.lstatSync(t)}catch{}if(r&&r.isSymbolicLink()){const n=ct.statSync(e),r=ct.statSync(t);if(dt(n,r))return}const i=lt(e,t);e=i.toDst,n=pt(i.toCwd,n);const o=ot.dirname(t);return ct.existsSync(o)||at(o),ct.symlinkSync(e,t,n)}};const{createFile:mt,createFileSync:St}=Je,{createLink:wt,createLinkSync:vt}=Ke,{createSymlink:gt,createSymlinkSync:Et}=ht;var kt={createFile:mt,createFileSync:St,ensureFile:mt,ensureFileSync:St,createLink:wt,createLinkSync:vt,ensureLink:wt,ensureLinkSync:vt,createSymlink:gt,createSymlinkSync:Et,ensureSymlink:gt,ensureSymlinkSync:Et};var bt={stringify:function(e,{EOL:t="\n",finalEOL:n=!0,replacer:r=null,spaces:i}={}){const o=n?t:"";return JSON.stringify(e,r,i).replace(/\n/g,t)+o},stripBom:function(e){return Buffer.isBuffer(e)&&(e=e.toString("utf8")),e.replace(/^\uFEFF/,"")}};let Ot;try{Ot=I}catch(En){Ot=e}const Pt=y,{stringify:Ft,stripBom:Ct}=bt;const xt=Pt.fromPromise((async function(e,t={}){"string"==typeof t&&(t={encoding:t});const n=t.fs||Ot,r=!("throws"in t)||t.throws;let i,o=await Pt.fromCallback(n.readFile)(e,t);o=Ct(o);try{i=JSON.parse(o,t?t.reviver:null)}catch(t){if(r)throw t.message=`${e}: ${t.message}`,t;return null}return i}));const _t=Pt.fromPromise((async function(e,t,n={}){const r=n.fs||Ot,i=Ft(t,n);await Pt.fromCallback(r.writeFile)(e,i,n)}));const Nt={readFile:xt,readFileSync:function(e,t={}){"string"==typeof t&&(t={encoding:t});const n=t.fs||Ot,r=!("throws"in t)||t.throws;try{let r=n.readFileSync(e,t);return r=Ct(r),JSON.parse(r,t.reviver)}catch(t){if(r)throw t.message=`${e}: ${t.message}`,t;return null}},writeFile:_t,writeFileSync:function(e,t,n={}){const r=n.fs||Ot,i=Ft(t,n);return r.writeFileSync(e,i,n)}};var $t={readJson:Nt.readFile,readJsonSync:Nt.readFileSync,writeJson:Nt.writeFile,writeJsonSync:Nt.writeFileSync};const Tt=y.fromPromise,Dt=p,Rt=o,It=q,Lt=X.pathExists;var At={outputFile:Tt((async function(e,t,n="utf-8"){const r=Rt.dirname(e);return await Lt(r)||await It.mkdirs(r),Dt.writeFile(e,t,n)})),outputFileSync:function(e,...t){const n=Rt.dirname(e);Dt.existsSync(n)||It.mkdirsSync(n),Dt.writeFileSync(e,...t)}};const{stringify:jt}=bt,{outputFile:Mt}=At;var Bt=async function(e,t,n={}){const r=jt(t,n);await Mt(e,r,n)};const{stringify:Wt}=bt,{outputFileSync:Vt}=At;var Ht=function(e,t,n){const r=Wt(t,n);Vt(e,r,n)};const Jt=y.fromPromise,Ut=$t;Ut.outputJson=Jt(Bt),Ut.outputJsonSync=Ht,Ut.outputJSON=Ut.outputJson,Ut.outputJSONSync=Ut.outputJsonSync,Ut.writeJSON=Ut.writeJson,Ut.writeJSONSync=Ut.writeJsonSync,Ut.readJSON=Ut.readJson,Ut.readJSONSync=Ut.readJsonSync;var Qt=Ut;const Gt=p,zt=o,{copy:Yt}=_e,{remove:qt}=$e,{mkdirp:Kt}=q,{pathExists:Zt}=X,Xt=ae;var en=async function(e,t,n={}){const r=n.overwrite||n.clobber||!1,{srcStat:i,isChangingCase:o=!1}=await Xt.checkPaths(e,t,"move",n);await Xt.checkParentPaths(e,i,t,"move");const c=zt.dirname(t);return zt.parse(c).root!==c&&await Kt(c),async function(e,t,n,r){if(!r)if(n)await qt(t);else if(await Zt(t))throw new Error("dest already exists.");try{await Gt.rename(e,t)}catch(r){if("EXDEV"!==r.code)throw r;await async function(e,t,n){const r={overwrite:n,errorOnExist:!0,preserveTimestamps:!0};return await Yt(e,t,r),qt(e)}(e,t,n)}}(e,t,r,o)};const tn=I,nn=o,rn=_e.copySync,on=$e.removeSync,cn=q.mkdirpSync,sn=ae;function an(e,t,n){try{tn.renameSync(e,t)}catch(r){if("EXDEV"!==r.code)throw r;return function(e,t,n){const r={overwrite:n,errorOnExist:!0,preserveTimestamps:!0};return rn(e,t,r),on(e)}(e,t,n)}}var un=function(e,t,n){const r=(n=n||{}).overwrite||n.clobber||!1,{srcStat:i,isChangingCase:o=!1}=sn.checkPathsSync(e,t,"move",n);return sn.checkParentPathsSync(e,i,t,"move"),function(e){const t=nn.dirname(e);return nn.parse(t).root===t}(t)||cn(nn.dirname(t)),function(e,t,n,r){if(r)return an(e,t,n);if(n)return on(t),an(e,t,n);if(tn.existsSync(t))throw new Error("dest already exists.");return an(e,t,n)}(e,t,r,o)};var ln={move:(0,y.fromPromise)(en),moveSync:un},fn=f({...p,..._e,...Me,...kt,...Qt,...q,...ln,...At,...X,...$e}),pn={};!function(t){var n,r,i,s,l,f,p="win32"===process.platform,y="aes-256-cbc",d="The current environment doesn't support interactive reading from TTY.",h=e,m=process.binding("tty_wrap").TTY,S=c,w=o,v={prompt:"> ",hideEchoBack:!1,mask:"*",limit:[],limitMessage:"Input another, please.$<( [)limit(])>",defaultInput:"",trueValue:[],falseValue:[],caseSensitive:!1,keepWhitespace:!1,encoding:"utf8",bufferSize:1024,print:void 0,history:!0,cd:!1,phContent:void 0,preCheck:void 0},g="none",E=!1,k=0,b="",O=[],P=!1,F=!1,C=!1;function x(e){return s.concat((t={display:"string",displayOnly:"boolean",keyIn:"boolean",hideEchoBack:"boolean",mask:"string",limit:"string",caseSensitive:"boolean"},n=[],Object.keys(t).forEach((function(r){"boolean"===t[r]?e[r]&&n.push("--"+r):"string"===t[r]&&e[r]&&n.push("--"+r,e[r].replace(/[^\w\u0080-\uFFFF]/g,(function(e){return"#"+e.charCodeAt(0)+";"})))})),n));var t,n}function _(e){var t,n,r={},o={env:process.env,encoding:e.encoding};if(i||(p?process.env.PSModulePath?(i="powershell.exe",s=["-ExecutionPolicy","Bypass","-File",__dirname+"\\read.ps1"]):(i="cscript.exe",s=["//nologo",__dirname+"\\read.cs.js"]):(i="/bin/sh",s=[__dirname+"/read.sh"])),p&&!process.env.PSModulePath&&(o.stdio=[process.stdin]),S.execFileSync){t=x(e),C&&C("execFileSync",t);try{r.input=S.execFileSync(i,t,o)}catch(e){n=e.stderr?(e.stderr+"").trim():"",r.error=new Error(d+(n?"\n"+n:"")),r.error.method="execFileSync",r.error.program=i,r.error.args=t,r.error.extMessage=n,r.error.exitCode=e.status,r.error.code=e.code,r.error.signal=e.signal}}else r=function(e,t){function n(e){var t,n,r="";for(l=l||a.tmpdir();;){t=w.join(l,e+r);try{n=h.openSync(t,"wx")}catch(e){if("EEXIST"===e.code){r++;continue}throw e}h.closeSync(n);break}return t}var r,o,c,s,f,m,v,g,E={},b=n("readline-sync.stdout"),O=n("readline-sync.stderr"),P=n("readline-sync.exit"),F=n("readline-sync.done"),_=u;(m=_.createHash("sha256")).update(""+process.pid+k+++Math.random()),g=m.digest("hex"),v=_.createDecipher(y,g),r=x(e),p?(o=process.env.ComSpec||"cmd.exe",process.env.Q='"',c=["/V:ON","/S","/C","(%Q%"+o+"%Q% /V:ON /S /C %Q%%Q%"+i+"%Q%"+r.map((function(e){return" %Q%"+e+"%Q%"})).join("")+" & (echo !ERRORLEVEL!)>%Q%"+P+"%Q%%Q%) 2>%Q%"+O+"%Q% |%Q%"+process.execPath+"%Q% %Q%"+__dirname+"\\encrypt.js%Q% %Q%"+y+"%Q% %Q%"+g+"%Q% >%Q%"+b+"%Q% & (echo 1)>%Q%"+F+"%Q%"]):(o="/bin/sh",c=["-c",'("'+i+'"'+r.map((function(e){return" '"+e.replace(/'/g,"'\\''")+"'"})).join("")+'; echo $?>"'+P+'") 2>"'+O+'" |"'+process.execPath+'" "'+__dirname+'/encrypt.js" "'+y+'" "'+g+'" >"'+b+'"; echo 1 >"'+F+'"']),C&&C("_execFileSync",r);try{S.spawn(o,c,t)}catch(e){E.error=new Error(e.message),E.error.method="_execFileSync - spawn",E.error.program=o,E.error.args=c}for(;"1"!==h.readFileSync(F,{encoding:e.encoding}).trim(););return"0"===(s=h.readFileSync(P,{encoding:e.encoding}).trim())?E.input=v.update(h.readFileSync(b,{encoding:"binary"}),"hex",e.encoding)+v.final(e.encoding):(f=h.readFileSync(O,{encoding:e.encoding}).trim(),E.error=new Error(d+(f?"\n"+f:"")),E.error.method="_execFileSync",E.error.program=o,E.error.args=c,E.error.extMessage=f,E.error.exitCode=+s),h.unlinkSync(b),h.unlinkSync(O),h.unlinkSync(P),h.unlinkSync(F),E}(e,o);return r.error||(r.input=r.input.replace(/^\s*'|'\s*$/g,""),e.display=""),r}function N(e){var t="",i=e.display,o=!e.display&&e.keyIn&&e.hideEchoBack&&!e.mask;function c(){var t=_(e);if(t.error)throw t.error;return t.input}return F&&F(e),function(){var e,t,i;function o(){return e||(e=process.binding("fs"),t=(t=process.binding("constants"))&&t.fs&&"number"==typeof t.fs.O_RDWR?t.fs:t),e}if("string"==typeof g)if(g=null,p){if((i=function(){var e=process.version.replace(/^\D+/,"").split("."),t=0;return(e[0]=+e[0])&&(t+=1e4*e[0]),(e[1]=+e[1])&&(t+=100*e[1]),(e[2]=+e[2])&&(t+=e[2]),t}())>=20302&&i<40204||i>=5e4&&i<50100||i>=50600&&i<60200||!process.stdin.isTTY)try{g=o().open("CONIN$",t.O_RDWR,parseInt("0666",8)),r=new m(g,!0)}catch(e){}else process.stdin.pause(),g=process.stdin.fd,r=process.stdin._handle;if(process.stdout.isTTY)n=process.stdout.fd;else{try{n=h.openSync("\\\\.\\CON","w")}catch(e){}if("number"!=typeof n)try{n=o().open("CONOUT$",t.O_RDWR,parseInt("0666",8))}catch(e){}}}else{if(process.stdin.isTTY){process.stdin.pause();try{g=h.openSync("/dev/tty","r"),r=process.stdin._handle}catch(e){}}else try{g=h.openSync("/dev/tty","r"),r=new m(g,!1)}catch(e){}if(process.stdout.isTTY)n=process.stdout.fd;else try{n=h.openSync("/dev/tty","w")}catch(e){}}}(),function(){var i,s,a,u,l,p,y,d=!e.hideEchoBack&&!e.keyIn;function m(e){return e===E||0===r.setRawMode(e)&&(E=e,!0)}if(f="",!P&&r&&("number"==typeof n||!e.display&&d)){if(e.display&&(h.writeSync(n,e.display),e.display=""),!e.displayOnly)if(m(!d)){for(u=e.keyIn?1:e.bufferSize,a=Buffer.allocUnsafe&&Buffer.alloc?Buffer.alloc(u):new Buffer(u),e.keyIn&&e.limit&&(s=new RegExp("[^"+e.limit+"]","g"+(e.caseSensitive?"":"i")));;){l=0;try{l=h.readSync(g,a,0,u)}catch(e){if("EOF"!==e.code)return m(!1),void(t+=c())}if(l>0?(p=a.toString(e.encoding,0,l),f+=p):(p="\n",f+=String.fromCharCode(0)),p&&"string"==typeof(y=(p.match(/^(.*?)[\r\n]/)||[])[1])&&(p=y,i=!0),p&&(p=p.replace(/[\x00-\x08\x0b\x0c\x0e-\x1f\x7f]/g,"")),p&&s&&(p=p.replace(s,"")),p&&(d||(e.hideEchoBack?e.mask&&h.writeSync(n,new Array(p.length+1).join(e.mask)):h.writeSync(n,p)),t+=p),!e.keyIn&&i||e.keyIn&&t.length>=u)break}d||o||h.writeSync(n,"\n"),m(!1)}else t=c()}else t=c()}(),e.print&&!o&&e.print(i+(e.displayOnly?"":(e.hideEchoBack?new Array(t.length+1).join(e.mask):t)+"\n"),e.encoding),e.displayOnly?"":b=e.keepWhitespace||e.keyIn?t:t.trim()}function $(e){return e.replace(/[\x00-\x7f]/g,(function(e){return"\\x"+("00"+e.charCodeAt().toString(16)).substr(-2)}))}function T(){var e,t,n=Array.prototype.slice.call(arguments);return n.length&&"boolean"==typeof n[0]&&(t=n.shift())&&(e=Object.keys(v),n.unshift(v)),n.reduce((function(n,r){return null==r||(r.hasOwnProperty("noEchoBack")&&!r.hasOwnProperty("hideEchoBack")&&(r.hideEchoBack=r.noEchoBack,delete r.noEchoBack),r.hasOwnProperty("noTrim")&&!r.hasOwnProperty("keepWhitespace")&&(r.keepWhitespace=r.noTrim,delete r.noTrim),t||(e=Object.keys(r)),e.forEach((function(e){var t,i,o,c;if(r.hasOwnProperty(e))switch(t=r[e],e){case"mask":case"limitMessage":case"defaultInput":case"encoding":(t=null!=t?t+"":"")&&"limitMessage"!==e&&(t=t.replace(/[\r\n]/g,"")),n[e]=t;break;case"bufferSize":isNaN(t=parseInt(t,10))||"number"!=typeof t||(n[e]=t);break;case"displayOnly":case"keyIn":case"hideEchoBack":case"caseSensitive":case"keepWhitespace":case"history":case"cd":n[e]=!!t;break;case"limit":case"trueValue":case"falseValue":n[e]=(i=t,o=function(e){var t=typeof e;return"string"===t||"number"===t||"function"===t||e instanceof RegExp},c=[],function e(t){null!=t&&(Array.isArray(t)?t.forEach(e):o&&!o(t)||c.push(t))}(i),c).map((function(e){return"string"==typeof e?e.replace(/[\r\n]/g,""):e}));break;case"print":case"phContent":case"preCheck":n[e]="function"==typeof t?t:void 0;break;case"prompt":case"display":n[e]=null!=t?t:""}}))),n}),{})}function D(e,t,n){return t.some((function(t){var r=typeof t;return"string"===r?n?e===t:e.toLowerCase()===t.toLowerCase():"number"===r?parseFloat(e)===t:"function"===r?t(e):t instanceof RegExp&&t.test(e)}))}function R(e,t){var n=w.normalize(p?(process.env.HOMEDRIVE||"")+(process.env.HOMEPATH||""):process.env.HOME||"").replace(/[/\\]+$/,"");return e=w.normalize(e),t?e.replace(/^~(?=\/|\\|$)/,n):e.replace(new RegExp("^"+$(n)+"(?=\\/|\\\\|$)",p?"i":""),"~")}function I(e,t){var n="(?:\\(([\\s\\S]*?)\\))?(\\w+|.-.)(?:\\(([\\s\\S]*?)\\))?",r=new RegExp("(\\$)?(\\$<"+n+">)","g"),i=new RegExp("(\\$)?(\\$\\{"+n+"\\})","g");function o(e,n,r,i,o,c){var s;return n||"string"!=typeof(s=t(o))?r:s?(i||"")+s+(c||""):""}return e.replace(r,o).replace(i,o)}function L(e,t,n){var r,i,o=[],c=-1,s=0,a="";function u(e,t){return t.length>3?(e.push(t[0]+"..."+t[t.length-1]),i=!0):t.length&&(e=e.concat(t)),e}return r=e.reduce((function(e,t){return e.concat((t+"").split(""))}),[]).reduce((function(e,r){var i,l;return t||(r=r.toLowerCase()),i=/^\d$/.test(r)?1:/^[A-Z]$/.test(r)?2:/^[a-z]$/.test(r)?3:0,n&&0===i?a+=r:(l=r.charCodeAt(0),i&&i===c&&l===s+1?o.push(r):(e=u(e,o),o=[r],c=i),s=l),e}),[]),r=u(r,o),a&&(r.push(a),i=!0),{values:r,suppressed:i}}function A(e,t){return e.join(e.length>2?", ":t?" / ":"/")}function j(e,t){var n,r,i,o={};if(t.phContent&&(n=t.phContent(e,t)),"string"!=typeof n)switch(e){case"hideEchoBack":case"mask":case"defaultInput":case"caseSensitive":case"keepWhitespace":case"encoding":case"bufferSize":case"history":case"cd":n=t.hasOwnProperty(e)?"boolean"==typeof t[e]?t[e]?"on":"off":t[e]+"":"";break;case"limit":case"trueValue":case"falseValue":r=t[t.hasOwnProperty(e+"Src")?e+"Src":e],n=A(r=t.keyIn?(o=L(r,t.caseSensitive)).values:r.filter((function(e){var t=typeof e;return"string"===t||"number"===t})),o.suppressed);break;case"limitCount":case"limitCountNotZero":n=(n=t[t.hasOwnProperty("limitSrc")?"limitSrc":"limit"].length)||"limitCountNotZero"!==e?n+"":"";break;case"lastInput":n=b;break;case"cwd":case"CWD":case"cwdHome":n=process.cwd(),"CWD"===e?n=w.basename(n):"cwdHome"===e&&(n=R(n));break;case"date":case"time":case"localeDate":case"localeTime":n=(new Date)["to"+e.replace(/^./,(function(e){return e.toUpperCase()}))+"String"]();break;default:"string"==typeof(i=(e.match(/^history_m(\d+)$/)||[])[1])&&(n=O[O.length-i]||"")}return n}function M(e){var t,n,r,i,o=/^(.)-(.)$/.exec(e),c="";if(!o)return null;for(i=(t=o[1].charCodeAt(0))<(n=o[2].charCodeAt(0))?1:-1,r=t;r!==n+i;r+=i)c+=String.fromCharCode(r);return c}function B(e){var t,n,r=new RegExp(/(\s*)(?:("|')(.*?)(?:\2|$)|(\S+))/g),i="",o=[];for(e=e.trim();t=r.exec(e);)n=t[3]||t[4]||"",t[1]&&(o.push(i),i=""),i+=n;return i&&o.push(i),o}function W(e,t){return!(!t.trueValue.length||!D(e,t.trueValue,t.caseSensitive))||(!t.falseValue.length||!D(e,t.falseValue,t.caseSensitive))&&e}function V(e){var t,n,r,i,o,c,s;function a(t){return j(t,e)}function u(t){e.display+=(/[^\r\n]$/.test(e.display)?"\n":"")+t}for(e.limitSrc=e.limit,e.displaySrc=e.display,e.limit="",e.display=I(e.display+"",a);;){if(t=N(e),n=!1,r="",e.defaultInput&&!t&&(t=e.defaultInput),e.history&&((i=/^\s*!(?:!|-1)(:p)?\s*$/.exec(t))?(o=O[0]||"",i[1]?n=!0:t=o,u(o+"\n"),n||(e.displayOnly=!0,N(e),e.displayOnly=!1)):t&&t!==O[O.length-1]&&(O=[t])),!n&&e.cd&&t)switch((c=B(t))[0].toLowerCase()){case"cd":if(c[1])try{process.chdir(R(c[1],!0))}catch(e){u(e+"")}n=!0;break;case"pwd":u(process.cwd()),n=!0}if(!n&&e.preCheck&&(t=(s=e.preCheck(t,e)).res,s.forceNext&&(n=!0)),!n){if(!e.limitSrc.length||D(t,e.limitSrc,e.caseSensitive))break;e.limitMessage&&(r=I(e.limitMessage,a))}u((r?r+"\n":"")+I(e.displaySrc+"",a))}return W(t,e)}function H(e,n,r){var i;return t.question(e,T({limitMessage:"Input valid number, please."},n,{limit:function(e){return i=r(e),!isNaN(i)&&"number"==typeof i},cd:!1})),i}function J(e,t){var n={},r={};return"object"==typeof e?(Object.keys(e).forEach((function(n){"function"==typeof e[n]&&(r[t.caseSensitive?n:n.toLowerCase()]=e[n])})),n.preCheck=function(e){var i;return n.args=B(e),i=n.args[0]||"",t.caseSensitive||(i=i.toLowerCase()),n.hRes="_"!==i&&r.hasOwnProperty(i)?r[i].apply(e,n.args.slice(1)):r.hasOwnProperty("_")?r._.apply(e,n.args):null,{res:e,forceNext:!1}},r.hasOwnProperty("_")||(n.limit=function(){var e=n.args[0]||"";return t.caseSensitive||(e=e.toLowerCase()),r.hasOwnProperty(e)})):n.preCheck=function(t){return n.args=B(t),n.hRes="function"!=typeof e||e.apply(t,n.args),{res:t,forceNext:!1}},n}function U(e,n,r){var i;return null==e&&(e="Are you sure? "),n&&!1===n.guide||!(e+="")||(e=e.replace(/\s*:?\s*$/,"")+" [y/n]: "),"boolean"==typeof(i=t.keyIn(e,T(n,{hideEchoBack:!1,limit:r,trueValue:"y",falseValue:"n",caseSensitive:!1})))?i:""}function Q(e,n){var r;return n.length&&((r={})[e]=n[0]),t.setDefaultOptions(r)[e]}t._DBG_set_useExt=function(e){P=e},t._DBG_set_checkOptions=function(e){F=e},t._DBG_set_checkMethod=function(e){C=e},t._DBG_clearHistory=function(){b="",O=[]},t.setDefaultOptions=function(e){return v=T(!0,e),T(!0)},t.question=function(e,t){return V(T(T(!0,t),{display:e}))},t.prompt=function(e){var t=T(!0,e);return t.display=t.prompt,V(t)},t.keyIn=function(e,t){var n=T(T(!0,t),{display:e,keyIn:!0,keepWhitespace:!0});return n.limitSrc=n.limit.filter((function(e){var t=typeof e;return"string"===t||"number"===t})).map((function(e){return I(e+"",M)})),n.limit=$(n.limitSrc.join("")),["trueValue","falseValue"].forEach((function(e){n[e]=n[e].reduce((function(e,t){var n=typeof t;return"string"===n||"number"===n?e=e.concat((t+"").split("")):e.push(t),e}),[])})),n.display=I(n.display+"",(function(e){return j(e,n)})),W(N(n),n)},t.questionEMail=function(e,n){return null==e&&(e="Input e-mail address: "),t.question(e,T({hideEchoBack:!1,limit:/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,limitMessage:"Input valid e-mail address, please.",trueValue:null,falseValue:null},n,{keepWhitespace:!1,cd:!1}))},t.questionNewPassword=function(e,n){var r,i,o,c,s,a,u,l,f,p,y=T({hideEchoBack:!0,mask:"*",limitMessage:"It can include: $<charlist>\nAnd the length must be: $<length>",trueValue:null,falseValue:null,caseSensitive:!0},n,{history:!1,cd:!1,phContent:function(e){return"charlist"===e?r.text:"length"===e?i+"..."+o:null}});for(c=I((n=n||{}).charlist?n.charlist+"":"$<!-~>",M),(isNaN(i=parseInt(n.min,10))||"number"!=typeof i)&&(i=12),(isNaN(o=parseInt(n.max,10))||"number"!=typeof o)&&(o=24),u=new RegExp("^["+$(c)+"]{"+i+","+o+"}$"),(r=L([c],y.caseSensitive,!0)).text=A(r.values,r.suppressed),s=null!=n.confirmMessage?n.confirmMessage:"Reinput a same one to confirm it: ",a=null!=n.unmatchMessage?n.unmatchMessage:"It differs from first one. Hit only the Enter key if you want to retry from first one.",null==e&&(e="Input new password: "),l=y.limitMessage;!p;)y.limit=u,y.limitMessage=l,f=t.question(e,y),y.limit=[f,""],y.limitMessage=a,p=t.question(s,y);return f},t.questionInt=function(e,t){return H(e,t,(function(e){return parseInt(e,10)}))},t.questionFloat=function(e,t){return H(e,t,parseFloat)},t.questionPath=function(e,n){var r,i="",o=T({hideEchoBack:!1,limitMessage:"$<error(\n)>Input valid path, please.$<( Min:)min>$<( Max:)max>",history:!0,cd:!0},n,{keepWhitespace:!1,limit:function(e){var t,o,c;function s(e){e.split(/\/|\\/).reduce((function(e,t){var n=w.resolve(e+=t+w.sep);if(h.existsSync(n)){if(!h.statSync(n).isDirectory())throw new Error("Non directory already exists: "+n)}else h.mkdirSync(n);return e}),"")}e=R(e,!0),i="";try{if(t=h.existsSync(e),r=t?h.realpathSync(e):w.resolve(e),!n.hasOwnProperty("exists")&&!t||"boolean"==typeof n.exists&&n.exists!==t)return i=(t?"Already exists":"No such file or directory")+": "+r,!1;if(!t&&n.create&&(n.isDirectory?s(r):(s(w.dirname(r)),h.closeSync(h.openSync(r,"w"))),r=h.realpathSync(r)),t&&(n.min||n.max||n.isFile||n.isDirectory)){if(o=h.statSync(r),n.isFile&&!o.isFile())return i="Not file: "+r,!1;if(n.isDirectory&&!o.isDirectory())return i="Not directory: "+r,!1;if(n.min&&o.size<+n.min||n.max&&o.size>+n.max)return i="Size "+o.size+" is out of range: "+r,!1}if("function"==typeof n.validate&&!0!==(c=n.validate(r)))return"string"==typeof c&&(i=c),!1}catch(e){return i=e+"",!1}return!0},phContent:function(e){return"error"===e?i:"min"!==e&&"max"!==e?null:n.hasOwnProperty(e)?n[e]+"":""}});return n=n||{},null==e&&(e='Input path (you can "cd" and "pwd"): '),t.question(e,o),r},t.promptCL=function(e,n){var r=T({hideEchoBack:!1,limitMessage:"Requested command is not available.",caseSensitive:!1,history:!0},n),i=J(e,r);return r.limit=i.limit,r.preCheck=i.preCheck,t.prompt(r),i.args},t.promptLoop=function(e,n){for(var r=T({hideEchoBack:!1,trueValue:null,falseValue:null,caseSensitive:!1,history:!0},n);!e(t.prompt(r)););},t.promptCLLoop=function(e,n){var r=T({hideEchoBack:!1,limitMessage:"Requested command is not available.",caseSensitive:!1,history:!0},n),i=J(e,r);for(r.limit=i.limit,r.preCheck=i.preCheck;t.prompt(r),!i.hRes;);},t.promptSimShell=function(e){return t.prompt(T({hideEchoBack:!1,history:!0},e,{prompt:p?"$<cwd>>":(process.env.USER||"")+(process.env.HOSTNAME?"@"+process.env.HOSTNAME.replace(/\..*$/,""):"")+":$<cwdHome>$ "}))},t.keyInYN=function(e,t){return U(e,t)},t.keyInYNStrict=function(e,t){return U(e,t,"yn")},t.keyInPause=function(e,n){null==e&&(e="Continue..."),n&&!1===n.guide||!(e+="")||(e=e.replace(/\s+$/,"")+" (Hit any key)"),t.keyIn(e,T({limit:null},n,{hideEchoBack:!0,mask:""}))},t.keyInSelect=function(e,n,r){var i=T({hideEchoBack:!1},r,{trueValue:null,falseValue:null,caseSensitive:!1,phContent:function(t){return"itemsCount"===t?e.length+"":"firstItem"===t?(e[0]+"").trim():"lastItem"===t?(e[e.length-1]+"").trim():null}}),o="",c={},s=49,a="\n";if(!Array.isArray(e)||!e.length||e.length>35)throw"`items` must be Array (max length: 35).";return e.forEach((function(e,t){var n=String.fromCharCode(s);o+=n,c[n]=t,a+="["+n+"] "+(e+"").trim()+"\n",s=57===s?97:s+1})),r&&!1===r.cancel||(o+="0",c[0]=-1,a+="[0] "+(r&&null!=r.cancel&&"boolean"!=typeof r.cancel?(r.cancel+"").trim():"CANCEL")+"\n"),i.limit=o,a+="\n",null==n&&(n="Choose one from list: "),(n+="")&&(r&&!1===r.guide||(n=n.replace(/\s*:?\s*$/,"")+" [$<limit>]: "),a+=n),c[t.keyIn(a,i).toLowerCase()]},t.getRawInput=function(){return f},t.setPrint=function(){return Q("print",arguments)},t.setPrompt=function(){return Q("prompt",arguments)},t.setEncoding=function(){return Q("encoding",arguments)},t.setMask=function(){return Q("mask",arguments)},t.setBufferSize=function(){return Q("bufferSize",arguments)}}(pn);var yn=f(pn);let dn,hn,mn=(e=21)=>{let t=(e=>{!dn||dn.length<e?(dn=Buffer.allocUnsafe(32*e),u.randomFillSync(dn),hn=0):hn+e>dn.length&&(u.randomFillSync(dn),hn=0);let t=dn.subarray(hn,hn+e);return hn+=e,t})(e),n="";for(;e--;)n+="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW"[63&t[e]];return n};const Sn=e=>{const t={};return e.split("\n").forEach((e=>{const n=/^([A-Z_0-9]+)=(?:'|")?(.+?)(?:'|")?$/g.exec(e);n&&(t[n[1]]=n[2])})),t};async function wn(e,t){let n=s(e,t,{stdio:"inherit"});return new Promise((e=>{n.on("exit",(t=>{e(t)}))}))}const vn="default.env",gn="env_files",[En,kn,...bn]=process.argv,On=o.dirname(kn),Pn=o.join(On,vn),Fn=fn.pathExistsSync(Pn);Fn||console.log(`WARNING: No valid ${vn} found`);const Cn=Fn?fn.readFileSync(Pn,"utf-8"):"",xn=Sn(Cn);(async()=>{0===bn.length&&bn.push(xn?.SITE??yn.question(`No site was specified in command line args or in ${vn}.\nPlease enter a site corresponding to an .env file in "${gn}" (or Enter to exit): `));for(const e of bn){""===e&&(console.log("No site specified...exiting"),process.exit(0)),console.log(`\nLaunching CONFORMA site: ${e}`);const t=o.join(On,gn,`${e}.env`);if(!fn.pathExistsSync(t)){console.log(`❌ ERROR: Missing site env file -- ${gn}/${e}.env`);continue}const n=Sn(fn.readFileSync(t,"utf-8")),r=process.env.TAG?"Environment variable":n?.TAG?`${e}.env`:xn?.TAG?vn:"User input",i=process.env.TAG??n?.TAG??xn?.TAG??yn.question(`No TAG specified. The build tag should be specified in either (in priority order): \n      - $TAG Environment variable\n      - In the site .env file: ${gn}/${e}.env\n      - In ${vn}\n  You can enter a build TAG now if you wish, or leave blank to skip site "${e}":\n  `);if(!i){console.log(`❌ No TAG specified for site...skipping "${e}"`);continue}process.env.TAG=i,console.log(`Using tag from ${r}: ${i}`);const c=process.env.BACKUPS_FOLDER??n?.BACKUPS_FOLDER??xn?.BACKUPS_FOLDER;if(!c){console.log(`❌ No BACKUPS_FOLDER specified for site...skipping "${e}"`);continue}process.env.BACKUPS_FOLDER=c,console.log(` - Backups folder: ${c}`);const s=process.env.SNAPSHOTS_FOLDER??n?.SNAPSHOTS_FOLDER??xn?.SNAPSHOTS_FOLDER;if(!s){console.log(`❌ No SNAPSHOTS_FOLDER specified for site...skipping "${e}"`);continue}process.env.SNAPSHOTS_FOLDER=s,console.log(` - Snapshots folder: ${s}`);const a=process.env.SHARE_FOLDER??n?.SHARE_FOLDER??xn?.BACKUPS_FOLDER;a?(process.env.SHARE_FOLDER=a,console.log(` - File share folder: ${a}`)):console.log("No SHARE_FOLDER specified for site...will use default");const u=n?.PORT??xn?.PORT;if(!u){console.log(`❌ No PORT specified for site...skipping "${e}"`);continue}process.env.PORT_APP=u,console.log(` - Conforma exposed on Port: ${u}`),process.env.PORT_DASH=String(Number(u)+1),console.log(` - Dashboard exposed on Port: ${process.env.PORT_DASH}`);const l=n?.WEB_HOST??xn?.WEB_HOST;if(!l){console.log(`❌ No WEB_HOST specified for site...skipping "${e}"`);continue}process.env.WEB_HOST=l,console.log(` - Website host: ${l}`);const f=process.env.JWT_SECRET??n?.JWT_SECRET??xn?.JWT_SECRET??mn(64),p=process.env.JWT_SECRET?"Environment variable":n?.JWT_SECRET?`${e}.env`:xn?.JWT_SECRET?vn:"Random value";process.env.JWT_SECRET=f,console.log(` - JWT private key set from ${p} (${f.length} chars)`);const y=`conforma-${e}-on-${u}`;console.log(`\n(Re-)starting ${y}...`);if(0!==await wn("sudo",["-E","docker","compose","--project-name",y,"down"])){console.log(`ERROR: Problem stopping ${y}`);continue}process.env.ENV_FILE=o.join(On,gn,`${e}.env`);const d=o.join(On,"docker-compose.yml");0===await wn("sudo",["-E","docker","compose","-f",d,"--project-name",y,"up","-d"])?console.log(`DONE: Successfully launched ${y}`):console.log(`ERROR: Problem launching ${y}`)}})();
